#!/bin/sh

# script which returs various zabbix statistics according to arguments
# 1. users: total amount of users
# 2. hosts: amount of hosts (second arg all or local)
# 3. items: amount of items
# 4. items_ps: amount of monitored items per second
# 5. triggers: amount of defined triggers
# 6. events: amount of events on pair
# 7. alerts: amount of alerts

# it requires that /etc/zabbix/server.conf is present (generated by zabbix_agent) 
# and /etc/zabbix/site.conf. Must contain line with that: Site=ETO

[ $# -lt 1 ] && echo "Invalid number of arguments" >&2 && exit 1

[ ! -f /etc/zabbix/server.conf ] && echo "Cannot determine pair!" >&2 && exit 0
PAIR=$(cat /etc/zabbix/server.conf | cut -d = -f 2)
SITE=$(cat /etc/zabbix/site.conf | cut -d = -f 2)

MYSQL="mysql -h $PAIR --user=ztop --password=oracle zabbix -B -N -e "


case $2 in
    all)
        ALL=1
        ;;
    local)
        ALL=0
        ;;
    '')
        ;;
    *)
        echo 0
        echo Second parameter is incorrect >&2
        exit 0
esac


case $1 in
    users)
        $MYSQL 'select count(*) from users;'
        ;;
    hosts)
        if [ $ALL -eq 1 ]; then
            $MYSQL "select count(*) from hosts;"
        else
            $MYSQL "select count(*) from hosts h, sites s where h.siteid=s.siteid and s.name=\"$SITE\";"
        fi
        ;;
    items)
        if [ $ALL -eq 1 ]; then
            $MYSQL 'select count(*) from items;'
        else
            $MYSQL "select count(*) from items i, hosts h, sites s where i.hostid=h.hostid and h.siteid=s.siteid and s.name=\"$SITE\";"
        fi
        ;;
    items_ps)
        if [ $ALL -eq 1 ]; then
            $MYSQL 'select sum(1/i.delay) from items i;'
        else
            $MYSQL "select sum(1/i.delay) from items i, hosts h, sites s where i.hostid=h.hostid and h.siteid=s.siteid and s.name=\"$SITE\";"
        fi
        ;;
    triggers)
        if [ $ALL -eq 1 ]; then
            $MYSQL 'select count(*) from triggers;'
        else
            $MYSQL "select count(*) from triggers t, functions f, items i, hosts h, sites s where f.triggerid=t.triggerid and f.itemid=i.itemid and i.hostid=h.hostid and h.siteid=s.siteid and s.name=\"$SITE\";"
        fi
        ;;
    events)
        if [ $ALL -eq 1 ]; then
            echo 0
        else
            $MYSQL 'select count(*) from events;'
        fi
        ;;
    alerts)
        if [ $ALL -eq 1 ]; then
            echo 0
        else
            $MYSQL 'select count(*) from alerts;'
        fi
        ;;
    *)
        echo First parameter is incorrect >&2
        echo 0
esac