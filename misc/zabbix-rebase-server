#!/usr/bin/perl -s

use IO::Socket;

$socket = IO::Socket::INET->new (
    PeerAddr => "setup.yandex.net",
    PeerPort => 80,
    Type => SOCK_STREAM) or die "Cannot connect to setup.yandex.net for rebase: $@\n";

$req = <<EOF;
GET /cgi-bin/get_monitoring_master HTTP/1.0

EOF

print $socket $req;

while (<$socket>) {
    chomp;
    last if /^\s*$/;
}

$srv = <$socket>;
print "Got new monitor server name: $srv";

close ($socket);

$cfg = "/etc/";
$cfg = "/usr/local$cfg" if $0 =~ /^\/usr\/local/;
$cfg .= "zabbix/server.conf";

open (FD, ">$cfg") or die "Cannot open config file for update\n";
print FD "Server=$srv";
close (FD);
